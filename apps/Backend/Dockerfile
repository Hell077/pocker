# ---------- STAGE 1: build Go server ----------
FROM golang:1.24.2-alpine AS builder

WORKDIR /app
COPY . .

# üëá –ü—É—Ç—å –¥–æ main.go (—É—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É: apps/Backend/cmd/main.go)
RUN CGO_ENABLED=0 GOOS=linux go build -o server ./apps/Backend/cmd/main.go

# ---------- STAGE 2: install Atlas CLI ----------
FROM alpine:latest AS atlas
RUN apk add --no-cache curl
# üëá –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Atlas –Ω–∞–ø—Ä—è–º—É—é –≤ –Ω—É–∂–Ω—É—é –ø–∞–ø–∫—É
RUN curl -sSf https://atlasgo.sh | sh -s -- -y --to /usr/local/bin

# ---------- STAGE 3: final runtime ----------
FROM alpine:latest

WORKDIR /root/

# –ë–∏–Ω–∞—Ä–Ω–∏–∫ Go-—Å–µ—Ä–≤–µ—Ä–∞
COPY --from=builder /app/server .

# –ë–∏–Ω–∞—Ä–Ω–∏–∫ Atlas CLI
COPY --from=atlas /usr/local/bin/atlas /usr/local/bin/atlas

# –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ atlas.hcl (–ø—É—Ç—å –≤–Ω—É—Ç—Ä–∏ builder ‚Üí /app/apps/Backend/packages/...)
COPY --from=builder /app/apps/Backend/packages/database ./database/
COPY --from=builder /app/apps/Backend/packages/atlas.hcl ./

# ‚úÖ ENV (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å ‚Äî –µ—Å–ª–∏ Railway –ø–µ—Ä–µ–¥–∞—ë—Ç DATABASE_URL —á–µ—Ä–µ–∑ secrets)
ENV PORT=3000
EXPOSE 3000

CMD ["./server"]
